#!/usr/bin/env bash
. "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/common"
OPTIND=1
while getopts a:p: OPT; do
  case "$OPT" in
    a)
      common_arch="$OPTARG"
      ;;
    p)
      common_prefix="$OPTARG"
      ;;
    ?)
      exit 2
      ;;
  esac
done
shift "$(($OPTIND - 1))"
common_setup
export PATH="${common_ctng_bin_dir}:${PATH}"
mkdir -p "${common_samples_out_dir}"
"${common_prefix}-gcc" -mcpu="${common_mcpu}" -c -o "${common_samples_out_dir}/main.o" "${common_root_dir}/main.c"
"${common_prefix}-gcc" -c -g -O3 -std=c99 -o "${common_samples_out_dir}/startup.o" "${common_root_dir}/startup.S"
"${common_prefix}-gcc" -mcpu="${common_mcpu}" -nostartfiles -c -o "${common_samples_out_dir}/syscalls.o" "${common_root_dir}/syscalls.c"
"${common_prefix}-gcc" \
  -nostartfiles \
  -o "$common_elf" \
  -T"${common_root_dir}/link.ld" \
  "${common_samples_out_dir}/startup.o" \
  "${common_samples_out_dir}/main.o" \
  "${common_samples_out_dir}/syscalls.o" \
;
"${common_prefix}-objcopy" -O binary "$common_elf" "$common_bin"
