#!/usr/bin/env bash
. "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/common"
debug=false
gem5=false
host=false
OPTIND=1
while getopts a:dhgt OPT; do
  case "$OPT" in
    a)
      common_arch="$OPTARG"
      ;;
    d)
      debug=true
      ;;
    g)
      gem5=true
      ;;
    h)
      host=true
      ;;
    t)
      common_gem5_build_type="$OPTARG"
      ;;
    ?)
      exit 2
      ;;
  esac
done
shift "$(($OPTIND - 1))"
common_setup
root_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if "$gem5"; then

gem5_build_dir="${1:-../gem5}"
if [ $# -gt 1 ]; then
  gem5_src_dir="$2"
else
  gem5_src_dir="$gem5_build_dir"
fi
cmd="\
'${common_gem5_exec}' \\
-d '${common_gem5_m5out_dir}' \\
--debug-file=trace.txt \\
--debug-flags='Exec' \\
'${common_gem5_dir}/configs/example/fs.py' \\
--bare-metal \\
--disk-image='${common_gem5_fake_iso}' \\
--kernel='${common_elf}' \\
--machine-type=RealView_PBX \\
--mem-size=256MB \\
"
else
  if "$debug"; then
    debug_flags="-S -gdb tcp::${common_gdb_port} \\
"
  else
    debug_flags=
  fi
  if "$host"; then
    qemu_exec="$common_qemu_exec_basename"
  else
    qemu_exec="$common_qemu_exec"
  fi
  cmd="\
'${qemu_exec}' \\
-M '${common_qemu_machine}' \\
-kernel '${common_bin}' \\
-serial mon:stdio \\
${debug_flags} \
"
fi
cmd="${cmd} $@"
echo "$cmd"
eval "$cmd"
